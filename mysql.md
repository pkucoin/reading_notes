# SQL查询语句的执行
- 连接器
  - 连接的权限在连接成功建立时确定，修改权限在下一次新连接才生效
  - 长连接过程中使用的资源在连接断开后才会被释放。mysql_reset_connection可以不断开连接的同时释放资源
- 查询缓存
  - 失效频繁。MySQL 8.0已被移除
- 分析器
  - 词法分析
  - 语法分析。表和列是否存在，别名是否有歧义等
- 优化器
  - 决定使用哪个索引、join连接顺序等
- 执行器
  - 检查用户对表的查询权限
  - 调用存储引擎的读取接口读取所有满足条件的行
 
 # SQL更新语句的执行
 - update T set c=c+1 where ID=2;
   - 执行器：取ID=2这一行
   - InnoDB: 检查数据页是否在内存中，返回行
   - 执行器：将c的值加一，写入
   - InnoDB：新数据更新到内存，写入redolog（prepare阶段）
   - 执行器：生成操作的binlog并写入。调用提交事务接口
   - InnoDb：写入的redolog改成commit状态，更新完成
- redolog和bin log

| ·| redolog | binlog  |
|  ----  | ----  |----  |
| 产生于  | InnoDB引擎 | MySQL执行器 |
| 记录内容  | 页面物理内容修改 | 逻辑操作 |
| 形式 | 固定长度、write_pos处循环写、check_point处已落盘|不断追加，超出大小写入新文件 |
| 用途| crash-safe，宕机后恢复已提交的记录|备份、回滚|

- 两阶段提交
  - 本质：MySQL server充当transaction coordinator来完成分布式事务的手段
  - 1.通知存储引擎准备->2.引擎返回准备ok->3.MySQL写binlog->4.引擎将prepare置为commit
  - 在3之前宕机：没有binlog，回滚
  - 在4之前宕机：有binlog和对应的prepare状态的记录，将对应的prepare状态的记录提交

# 事务隔离级别
- 并发事务可能导致的问题
  - 第一类丢失更新：两个事务更新同一条数据，事务A完成，事务B回滚导致事务A的更新丢失。现代关系型数据库不存在此问题
  - 脏读：事务A执行中修改了数据，事务B读取了这一修改的数据，事务A回滚，导致事务B读到的是错误的数据
  - 不可重复读：事务A读取了一条数据，事务B更新了这一数据，事务A再次读取该数据，读到的值与第一次读取不同
  - 幻读：事务A读取了符合某一条件的数据集合x，事务B添加或删除了一些数据，事务A再次读取符合同一条件的数据集合y，x与y不同
  - 第二类丢失更新：两个事务同时更新同一条数据，后完成的事务将覆盖先完成的事务的更新
  
- 事务隔离级别
  - 读未提交：事务可以看到其他未提交事务所做的改变
  - 读已提交：事务只能看到其他已提交事务所做的改变。解决了脏读
  - 可重复读：一个事务内对同一数据的重复读取结果是一致的。解决了脏读、不可重复读
    - MySQL的默认事务隔离级别
    - InnoDB加入了区间锁，读/写时除了对满足条件的记录加锁，记录之间的区间也加锁，保证不会出现区间内的插入操作，解决了幻读问题
  - 可串行化：强制事务串行执行，没有任何问题
  
- 应该尽量避免长事务
  - set autocommit=1，使用begin显式启动事务，使用commit work and chain提交事务并自动启动下一个事务
  - 查询长事务：select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60
  
# 索引
- B+树
  - N叉平衡搜索树，每个节点内的key有序，数量等于子节点数量-1
  - 每个节点有[N/2，N-1]个key
  - key左子中的key小于key，右子中的key大于key
  - 叶子节点位于同一高度，并以指针连接右兄弟节点，叶子节点的子节点指向硬盘中的数据块
  - 插入节点时找到对应的叶子节点，如key数量上溢则需要分裂，并更新父节点的key
  - 删除节点时找到对应的叶子节点，如key数量下溢则先考虑向兄弟节点借key，如果不够则合并兄弟节点
- InnoDB索引
  - 主键索引，也称聚簇索引，其叶子节点存的是整行数据
  - 非主键索引，也称二级索引，其叶子节点存的是主键的值
  - 基于非主键索引的查询需要先查二级索引得到主键值，然后查主键索引得到数据
- 自增主键
  - 降低了索引插入操作的成本
  - 节省了存储空间
  - 单纯的kv场景适合使用业务字段做主键
- 重建索引
  - 新的索引把数据按顺序插入，页面利用率高，使得索引更紧凑
  - TODO：怎么做？
- 
